#!/bin/bash
# =============================================================================
# Setup de Usuários para Teste BOLA/IDOR
# =============================================================================
# Este script cria 2 usuários de teste em organizações diferentes
# para permitir testes de autorização cross-tenant (BOLA)
# =============================================================================

set -e

BASE_URL="${1:-http://localhost:3000}"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${GREEN}================================================${NC}"
echo -e "${GREEN}  Setup de Usuários para Pentest BOLA${NC}"
echo -e "${GREEN}================================================${NC}"
echo ""

# Criar diretório para tokens
mkdir -p security-tests/tokens

echo -e "${YELLOW}IMPORTANTE:${NC}"
echo -e "Este script deve ser executado com um admin para criar:"
echo -e "1. Organização A com Usuário A"
echo -e "2. Organização B com Usuário B"
echo ""
echo -e "Para testes manuais, você pode criar via API ou banco:"
echo ""

cat << 'EOF'
# Exemplo de criação via SQL (rode no psql):

-- Organização A
INSERT INTO organizations (id, name, slug, created_at, updated_at)
VALUES (
    'aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa',
    'Pentest Org A',
    'pentest-org-a',
    NOW(), NOW()
);

-- Organização B
INSERT INTO organizations (id, name, slug, created_at, updated_at)
VALUES (
    'bbbbbbbb-bbbb-bbbb-bbbb-bbbbbbbbbbbb',
    'Pentest Org B',
    'pentest-org-b',
    NOW(), NOW()
);

-- Usuário A (org A)
INSERT INTO users (id, organization_id, email, name, role, created_at, updated_at)
VALUES (
    '11111111-1111-1111-1111-111111111111',
    'aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa',
    'pentest-a@test.com',
    'Pentest User A',
    'ADMIN',
    NOW(), NOW()
);

-- Usuário B (org B)
INSERT INTO users (id, organization_id, email, name, role, created_at, updated_at)
VALUES (
    '22222222-2222-2222-2222-222222222222',
    'bbbbbbbb-bbbb-bbbb-bbbb-bbbbbbbbbbbb',
    'pentest-b@test.com',
    'Pentest User B',
    'ADMIN',
    NOW(), NOW()
);

EOF

echo ""
echo -e "${YELLOW}Após criar os usuários, obtenha tokens JWT para cada um:${NC}"
echo ""
echo -e "# Token para Usuário A"
echo -e "curl -X POST $BASE_URL/api/v1/auth/web/token \\"
echo -e "  -H 'Content-Type: application/json' \\"
echo -e "  -d '{\"email\":\"pentest-a@test.com\",\"password\":\"senha\"}'"
echo ""
echo -e "# Token para Usuário B"
echo -e "curl -X POST $BASE_URL/api/v1/auth/web/token \\"
echo -e "  -H 'Content-Type: application/json' \\"
echo -e "  -d '{\"email\":\"pentest-b@test.com\",\"password\":\"senha\"}'"
echo ""
echo -e "${GREEN}Salve os tokens em:${NC}"
echo -e "  security-tests/tokens/user-a.token"
echo -e "  security-tests/tokens/user-b.token"
echo ""
echo -e "${GREEN}Depois execute:${NC}"
echo -e "  ./security-tests/scripts/bola-test.sh"
