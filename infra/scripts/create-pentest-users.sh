#!/bin/bash
# =============================================================================
# Criação de Usuários de Teste para Pentest
# =============================================================================
# Este script cria usuários e organizações de teste para executar
# testes de segurança BOLA/IDOR e escalação de privilégios
# =============================================================================

set -e

# Configurações
DB_HOST="${DB_HOST:-localhost}"
DB_PORT="${DB_PORT:-5432}"
DB_NAME="${DB_NAME:-construgame}"
DB_USER="${DB_USER:-postgres}"
DB_PASSWORD="${DB_PASSWORD:-postgres}"

# Cores
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${GREEN}╔══════════════════════════════════════════════════════════════╗${NC}"
echo -e "${GREEN}║       Criação de Usuários de Teste para Pentest              ║${NC}"
echo -e "${GREEN}╚══════════════════════════════════════════════════════════════╝${NC}"
echo ""

# Verificar conexão com o banco
echo -e "${BLUE}[1/4] Verificando conexão com o banco...${NC}"
if ! PGPASSWORD="$DB_PASSWORD" psql -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USER" -d "$DB_NAME" -c "SELECT 1" > /dev/null 2>&1; then
    echo -e "${RED}✗ Não foi possível conectar ao banco de dados${NC}"
    echo "  Host: $DB_HOST:$DB_PORT"
    echo "  Database: $DB_NAME"
    echo "  User: $DB_USER"
    exit 1
fi
echo -e "${GREEN}✓ Conexão estabelecida${NC}"

# IDs fixos para testes (facilita referência nos scripts)
ORG_A_ID="aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa"
ORG_B_ID="bbbbbbbb-bbbb-bbbb-bbbb-bbbbbbbbbbbb"
USER_A_ID="11111111-1111-1111-1111-111111111111"
USER_B_ID="22222222-2222-2222-2222-222222222222"
USER_A_ADMIN_ID="11111111-1111-1111-1111-111111111112"

# Senha padrão (hash bcrypt de "pentest123")
# Gerado com: node -e "console.log(require('bcryptjs').hashSync('pentest123', 10))"
PASSWORD_HASH='$2b$10$Xw7JQhCyTCS3a320pMmpK.V8.04u71hzAQtVIuCdwpR6o1QuOIlRK'

echo -e "\n${BLUE}[2/4] Criando organizações de teste...${NC}"

PGPASSWORD="$DB_PASSWORD" psql -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USER" -d "$DB_NAME" << EOF
-- Limpar dados anteriores (se existirem)
DELETE FROM members WHERE organization_id IN ('$ORG_A_ID', '$ORG_B_ID');
DELETE FROM organizations WHERE id IN ('$ORG_A_ID', '$ORG_B_ID');
DELETE FROM users WHERE id IN ('$USER_A_ID', '$USER_B_ID', '$USER_A_ADMIN_ID');

-- Criar usuários
INSERT INTO users (id, name, email, password, status, type, sequence, created_at, updated_at)
VALUES 
    ('$USER_A_ID', 'Pentest User A (Player)', 'pentest-a@test.com', '$PASSWORD_HASH', 'ACTIVE', 'user', 1, NOW(), NOW()),
    ('$USER_A_ADMIN_ID', 'Pentest User A (Admin)', 'pentest-a-admin@test.com', '$PASSWORD_HASH', 'ACTIVE', 'user', 2, NOW(), NOW()),
    ('$USER_B_ID', 'Pentest User B', 'pentest-b@test.com', '$PASSWORD_HASH', 'ACTIVE', 'user', 3, NOW(), NOW())
ON CONFLICT (id) DO UPDATE SET
    name = EXCLUDED.name,
    email = EXCLUDED.email,
    password = EXCLUDED.password,
    status = EXCLUDED.status,
    updated_at = NOW();

-- Criar organizações
INSERT INTO organizations (id, owner_id, name, sequence, created_at, updated_at)
VALUES 
    ('$ORG_A_ID', '$USER_A_ADMIN_ID', 'Pentest Organization A', 1, NOW(), NOW()),
    ('$ORG_B_ID', '$USER_B_ID', 'Pentest Organization B', 2, NOW(), NOW())
ON CONFLICT (id) DO UPDATE SET
    name = EXCLUDED.name,
    owner_id = EXCLUDED.owner_id,
    updated_at = NOW();

-- Criar memberships
INSERT INTO members (user_id, organization_id, role, sequence)
VALUES 
    -- Org A: admin + player
    ('$USER_A_ADMIN_ID', '$ORG_A_ID', 'admin', 1),
    ('$USER_A_ID', '$ORG_A_ID', 'player', 2),
    -- Org B: apenas owner/admin
    ('$USER_B_ID', '$ORG_B_ID', 'owner', 1)
ON CONFLICT (user_id, organization_id) DO UPDATE SET
    role = EXCLUDED.role;
EOF

echo -e "${GREEN}✓ Organizações criadas${NC}"

echo -e "\n${BLUE}[3/4] Verificando dados criados...${NC}"

PGPASSWORD="$DB_PASSWORD" psql -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USER" -d "$DB_NAME" << EOF
\echo '=== Usuários ==='
SELECT id, name, email, status, type FROM users 
WHERE email LIKE 'pentest%' ORDER BY email;

\echo ''
\echo '=== Organizações ==='
SELECT id, name, owner_id FROM organizations 
WHERE id IN ('$ORG_A_ID', '$ORG_B_ID');

\echo ''
\echo '=== Memberships ==='
SELECT u.email, o.name as organization, m.role 
FROM members m
JOIN users u ON m.user_id = u.id
JOIN organizations o ON m.organization_id = o.id
WHERE m.organization_id IN ('$ORG_A_ID', '$ORG_B_ID')
ORDER BY o.name, m.role;
EOF

echo -e "\n${BLUE}[4/4] Resumo dos usuários de teste${NC}"
echo -e "-------------------------------------------"
echo ""
echo -e "${YELLOW}Organização A:${NC} $ORG_A_ID"
echo -e "  Admin: pentest-a-admin@test.com (ID: $USER_A_ADMIN_ID)"
echo -e "  Player: pentest-a@test.com (ID: $USER_A_ID)"
echo ""
echo -e "${YELLOW}Organização B:${NC} $ORG_B_ID"
echo -e "  Owner: pentest-b@test.com (ID: $USER_B_ID)"
echo ""
echo -e "${YELLOW}Senha para todos:${NC} pentest123"
echo ""
echo -e "-------------------------------------------"
echo -e "${GREEN}Para obter tokens JWT:${NC}"
echo ""
echo -e "# User A (player da Org A)"
echo -e "curl -X POST http://localhost:3000/api/v1/auth/web/token \\"
echo -e "  -H 'Content-Type: application/json' \\"
echo -e "  -d '{\"email\":\"pentest-a@test.com\",\"password\":\"pentest123\"}'"
echo ""
echo -e "# User A Admin (admin da Org A)"
echo -e "curl -X POST http://localhost:3000/api/v1/auth/web/token \\"
echo -e "  -H 'Content-Type: application/json' \\"
echo -e "  -d '{\"email\":\"pentest-a-admin@test.com\",\"password\":\"pentest123\"}'"
echo ""
echo -e "# User B (owner da Org B)"
echo -e "curl -X POST http://localhost:3000/api/v1/auth/web/token \\"
echo -e "  -H 'Content-Type: application/json' \\"
echo -e "  -d '{\"email\":\"pentest-b@test.com\",\"password\":\"pentest123\"}'"
echo ""
echo -e "${GREEN}Salve os tokens em:${NC}"
echo -e "  security-tests/tokens/user-a.token"
echo -e "  security-tests/tokens/user-a-admin.token"
echo -e "  security-tests/tokens/user-b.token"
echo ""
echo -e "${GREEN}✓ Setup completo!${NC}"
