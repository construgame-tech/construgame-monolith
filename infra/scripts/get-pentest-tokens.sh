#!/bin/bash
# =============================================================================
# Obter Tokens JWT para Usuários de Teste
# =============================================================================
# Após criar os usuários com create-pentest-users.sh, use este script
# para obter e salvar os tokens JWT automaticamente
# =============================================================================

set -e

BASE_URL="${1:-http://localhost:3000}"
TOKENS_DIR="security-tests/tokens"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${GREEN}╔══════════════════════════════════════════════════════════════╗${NC}"
echo -e "${GREEN}║           Obtendo Tokens JWT para Pentest                    ║${NC}"
echo -e "${GREEN}╚══════════════════════════════════════════════════════════════╝${NC}"
echo ""

mkdir -p "$TOKENS_DIR"

# Função para obter token
get_token() {
    local email=$1
    local password=$2
    local output_file=$3
    local description=$4
    
    echo -e "  Obtendo token para ${YELLOW}$email${NC}..."
    
    response=$(curl -s -X POST "$BASE_URL/api/v1/auth/web/token" \
        -H "Content-Type: application/json" \
        -d "{\"email\":\"$email\",\"password\":\"$password\"}" \
        --max-time 10 2>/dev/null)
    
    # Tentar extrair token (pode variar conforme resposta da API)
    token=$(echo "$response" | jq -r '.accessToken // .access_token // .token // empty' 2>/dev/null)
    
    if [ -n "$token" ] && [ "$token" != "null" ]; then
        echo "$token" > "$TOKENS_DIR/$output_file"
        echo -e "    ${GREEN}✓${NC} Salvo em $TOKENS_DIR/$output_file"
        return 0
    else
        error=$(echo "$response" | jq -r '.message // .error // empty' 2>/dev/null)
        if [ -n "$error" ]; then
            echo -e "    ${RED}✗${NC} Erro: $error"
        else
            echo -e "    ${RED}✗${NC} Resposta: $response"
        fi
        return 1
    fi
}

echo -e "[1/3] Obtendo tokens..."
echo ""

# User A (Player)
get_token "pentest-a@test.com" "pentest123" "user-a.token" "Player Org A"

# User A Admin
get_token "pentest-a-admin@test.com" "pentest123" "user-a-admin.token" "Admin Org A"

# User B
get_token "pentest-b@test.com" "pentest123" "user-b.token" "Owner Org B"

echo ""
echo -e "[2/3] Verificando tokens salvos..."
echo ""

for file in user-a.token user-a-admin.token user-b.token; do
    if [ -f "$TOKENS_DIR/$file" ]; then
        size=$(wc -c < "$TOKENS_DIR/$file")
        if [ "$size" -gt 50 ]; then
            echo -e "  ${GREEN}✓${NC} $file ($size bytes)"
        else
            echo -e "  ${YELLOW}⚠${NC} $file parece inválido ($size bytes)"
        fi
    else
        echo -e "  ${RED}✗${NC} $file não encontrado"
    fi
done

echo ""
echo -e "[3/3] Testando tokens..."
echo ""

test_token() {
    local file=$1
    local description=$2
    
    if [ -f "$TOKENS_DIR/$file" ]; then
        token=$(cat "$TOKENS_DIR/$file")
        response=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer $token" \
            "$BASE_URL/api/v1/organization" \
            --max-time 5 2>/dev/null)
        
        if [ "$response" = "200" ]; then
            echo -e "  ${GREEN}✓${NC} $description: Token válido (HTTP 200)"
        elif [ "$response" = "401" ]; then
            echo -e "  ${RED}✗${NC} $description: Token inválido (HTTP 401)"
        else
            echo -e "  ${YELLOW}?${NC} $description: HTTP $response"
        fi
    fi
}

test_token "user-a.token" "User A (Player)"
test_token "user-a-admin.token" "User A (Admin)"
test_token "user-b.token" "User B (Owner)"

echo ""
echo -e "${GREEN}═══════════════════════════════════════════════════════════════${NC}"
echo -e "Tokens salvos em: ${YELLOW}$TOKENS_DIR/${NC}"
echo -e ""
echo -e "Agora você pode executar:"
echo -e "  ${YELLOW}./security-tests/scripts/bola-test.sh${NC}"
echo -e "${GREEN}═══════════════════════════════════════════════════════════════${NC}"
